<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.david.hlp.Spring.repeater.mapper.RouterUrlMapper">
    <!-- 公共查询列 -->
    <sql id="Base_Column_List">
        id, host, port, router, protocol, unique_id, type, doc, gmt_create, gmt_modified, is_deleted
    </sql>
    
    <!-- 插入路由信息 -->
    <insert id="insertRouterUrl" parameterType="com.david.hlp.Spring.repeater.module.entity.RouterUrl">
        INSERT INTO router_url (
            host, port, router, protocol, unique_id, type, doc, gmt_create, gmt_modified, is_deleted
        ) VALUES (
            #{host}, #{port}, #{router}, #{protocol}, #{uniqueId}, #{type}, #{doc}, NOW(), NOW(), 0
        )
    </insert>
    
    <!-- 更新路由信息 -->
    <update id="updateRouterUrl" parameterType="com.david.hlp.Spring.repeater.module.entity.RouterUrl">
        UPDATE router_url
        <set>
            <if test="host != null">host = #{host},</if>
            <if test="port != null">port = #{port},</if>
            <if test="router != null">router = #{router},</if>
            <if test="protocol != null">protocol = #{protocol},</if>
            <if test="uniqueId != null">unique_id = #{uniqueId},</if>
            <if test="type != null">type = #{type},</if>
            <if test="doc != null">doc = #{doc},</if>
            gmt_modified = NOW()
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>
    
    <!-- 删除路由信息(软删除) -->
    <update id="deleteRouterUrl" parameterType="com.david.hlp.Spring.repeater.module.entity.RouterUrl">
        UPDATE router_url
        SET is_deleted = 1, gmt_modified = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>
    
    <!-- 统计路由数量 -->
    <select id="countRouterUrl" parameterType="com.david.hlp.Spring.repeater.module.entity.RouterUrl" resultType="java.lang.Long">
        SELECT COUNT(1) FROM router_url
        <where>
            is_deleted = 0
            <if test="host != null and host != ''">AND host LIKE CONCAT('%', #{host}, '%')</if>
            <if test="port != null">AND port = #{port}</if>
            <if test="router != null and router != ''">AND router LIKE CONCAT('%', #{router}, '%')</if>
            <if test="protocol != null and protocol != ''">AND protocol = #{protocol}</if>
            <if test="uniqueId != null and uniqueId != ''">AND unique_id = #{uniqueId}</if>
            <if test="type != null">AND type = #{type}</if>
        </where>
    </select>
    
    <!-- 分页查询路由信息 -->
    <select id="listRouterUrl" resultType="com.david.hlp.Spring.repeater.module.entity.RouterUrl">
        SELECT
        <include refid="Base_Column_List" />
        FROM router_url
        <where>
            is_deleted = 0
            <if test="routerUrl.host != null and routerUrl.host != ''">AND host LIKE CONCAT('%', #{routerUrl.host}, '%')</if>
            <if test="routerUrl.port != null">AND port = #{routerUrl.port}</if>
            <if test="routerUrl.router != null and routerUrl.router != ''">AND router LIKE CONCAT('%', #{routerUrl.router}, '%')</if>
            <if test="routerUrl.protocol != null and routerUrl.protocol != ''">AND protocol = #{routerUrl.protocol}</if>
            <if test="routerUrl.uniqueId != null and routerUrl.uniqueId != ''">AND unique_id = #{routerUrl.uniqueId}</if>
            <if test="routerUrl.type != null">AND type = #{routerUrl.type}</if>
        </where>
        ORDER BY id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
    <!-- 查询所有路由信息 -->
    <select id="listAllRouterUrl" resultType="com.david.hlp.Spring.repeater.module.entity.RouterUrl">
        SELECT
        <include refid="Base_Column_List" />
        FROM router_url
        WHERE is_deleted = 0
        ORDER BY id DESC
    </select>
</mapper>
